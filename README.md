# Аудио Стриминг Сервер

Это приложение создает веб-сервер для потоковой передачи аудиофайлов в браузер. Приложение сканирует указанные директории для поиска аудиофайлов и транслирует их по соответствующим маршрутам.

## Возможности

- Автоматическое сканирование директорий для поиска .mp3 и .wav файлов
- Полная поддержка Unicode и специальных символов в именах файлов
- Трансляция аудиофайлов через HTTP
- Автоматическое воспроизведение аудиопотока в браузере
- Отображение информации о текущем треке
- Автоматический переход к следующему треку после завершения воспроизведения
- Логирование ошибок в Sentry
- Контейнеризация с использованием Docker
- Настраиваемые URL-пути для аудиопотоков (например, `/humor`, `/science` и т.д.)
- **Поддержка разных директорий для разных аудиопотоков** (например: `/app/humor` ➝ `/humor`)
- **Режим настоящего радио**: все слушатели слышат одинаковый контент одновременно
- **Буферизация потока** для синхронизации всех подключенных клиентов
- **Предзагрузка треков** для более плавного воспроизведения
- **Учет слушателей** и статистика для каждого потока
- **Улучшенная обработка ошибок** включая перехват TLS-соединений и таймаутов
- **Оптимизация памяти** для работы с большими аудиофайлами

## Режимы работы

Аудио Стриминг Сервер поддерживает два режима работы:

### 1. Режим "Радио" (по умолчанию)

В этом режиме создается один непрерывный поток для каждого маршрута. Все слушатели получают одинаковый аудиоконтент одновременно, как в настоящем радио.

**Особенности режима радио:**
- Единый синхронизированный поток для всех слушателей
- Воспроизведение продолжается даже при отсутствии активных слушателей
- Буферизация данных для синхронизации всех подключений
- Предзагрузка треков для более плавного воспроизведения
- Отслеживание числа активных слушателей

### 2. Режим "Индивидуальный" (legacy)

В этом режиме для каждого подключенного клиента создается отдельный поток воспроизведения. Каждый слушатель может получать разные треки в разное время.

**Особенности индивидуального режима:**
- Независимое воспроизведение для каждого слушателя
- Воспроизведение начинается только при подключении клиента
- Плейлист перемешивается индивидуально для каждого клиента

## Архитектура проекта

Проект разделен на несколько модулей:

- `main.py` - Главный модуль приложения, инициализирует и запускает все компоненты
- `playlist_manager.py` - Сканирует директории, управляет плейлистами и радиопотоками
- `audio_streamer.py` - Обрабатывает аудиофайлы и создает потоковый контент
- `web_server.py` - Веб-сервер для доставки аудиопотока через HTTP
- `logger.py` - Настраивает логирование и интеграцию с Sentry

## Запуск приложения

### Параметры командной строки

Приложение поддерживает следующие параметры командной строки:

- `--audio-dir` - Путь к директории с аудиофайлами по умолчанию (по умолчанию: /app/audio)
- `--port` - Порт для веб-сервера (по умолчанию: 9999)
- `--host` - Хост для веб-сервера (по умолчанию: 0.0.0.0)
- `--stream-routes` - Список URL-путей для аудиопотока, разделённых запятыми (например: "/,/humor,/science")
- `--directory-routes` - JSON строка с сопоставлением директорий и маршрутов (например: '{"humor":"/app/humor","science":"/app/science"}')
- `--stream-mode` - Режим стриминга: "radio" (все слушатели слышат один поток) или "individual" (у каждого слушателя свой поток)
- `--buffer-size` - Размер буфера аудиопотока в байтах (по умолчанию: 2MB)
- `--max-preload-tracks` - Максимальное количество предзагружаемых треков (по умолчанию: 2)

### Переменные окружения

Приложение поддерживает следующие переменные окружения:

- `AUDIO_STREAM_ROUTES` - Список URL-путей для аудиопотока, разделенных запятыми (по умолчанию: `/`). Например: `/,/humor,/science`
- `DIRECTORY_ROUTES` - JSON строка с сопоставлением маршрутов и директорий. Например: `{"humor":"/app/humor","science":"/app/science"}`
- `STREAM_MODE` - Режим стриминга: "radio" или "individual" (по умолчанию: "radio")
- `BUFFER_SIZE` - Размер буфера аудиопотока в байтах (по умолчанию: 2097152 или 2MB)
- `MAX_PRELOAD_TRACKS` - Максимальное количество предзагружаемых треков (по умолчанию: 2)

### Оптимизация использования памяти

Для предотвращения проблем с нехваткой памяти при стриминге больших аудиофайлов, используйте следующие настройки:

1. **Уменьшение размера буфера**:
   ```bash
   # Установка буфера размером 1MB (1048576 байт)
   python main.py --buffer-size 1048576
   ```

2. **Уменьшение количества предзагружаемых треков**:
   ```bash
   # Предзагрузка только одного следующего трека
   python main.py --max-preload-tracks 1
   ```

3. **Комбинированный подход для Docker**:
   ```bash
   docker run -d --name audio-stream-server -p 9999:9999 \
     -v /путь/к/аудио:/app/audio \
     -e BUFFER_SIZE=1048576 \
     -e MAX_PRELOAD_TRACKS=1 \
     audio-streamer
   ```

### Локально

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Установите ffmpeg (необходим для работы с аудиофайлами):
```bash
# Для Ubuntu/Debian
sudo apt-get install ffmpeg

# Для macOS с Homebrew
brew install ffmpeg

# Для Windows с Chocolatey
choco install ffmpeg
```

3. Создайте директории для разных аудиопотоков:
```bash
mkdir -p ~/audio/humor ~/audio/science ~/audio/default
```

4. Запустите приложение, указав сопоставление директорий и маршрутов:
```bash
python main.py --audio-dir ~/audio/default --directory-routes '{"humor":"~/audio/humor","science":"~/audio/science"}'
```

5. Для настройки через переменные окружения:
```bash
# Linux/macOS
export DIRECTORY_ROUTES='{"humor":"~/audio/humor","science":"~/audio/science"}'
export AUDIO_STREAM_ROUTES="/,/humor,/science"
export STREAM_MODE="radio"  # или "individual" для индивидуального режима
export BUFFER_SIZE=1048576  # 1MB для экономии памяти
export MAX_PRELOAD_TRACKS=1  # Предзагрузка только одного трека
python main.py --audio-dir ~/audio/default

# Windows PowerShell
$env:DIRECTORY_ROUTES='{"humor":"C:\\audio\\humor","science":"C:\\audio\\science"}'
$env:AUDIO_STREAM_ROUTES="/,/humor,/science"
$env:STREAM_MODE="radio"
$env:BUFFER_SIZE=1048576
$env:MAX_PRELOAD_TRACKS=1
python main.py --audio-dir C:\audio\default

# Windows CMD
set DIRECTORY_ROUTES={"humor":"C:\\audio\\humor","science":"C:\\audio\\science"}
set AUDIO_STREAM_ROUTES=/,/humor,/science
set STREAM_MODE=radio
set BUFFER_SIZE=1048576
set MAX_PRELOAD_TRACKS=1
python main.py --audio-dir C:\audio\default
```

6. Откройте в браузере следующие URL для доступа к разным аудиопотокам:
   - `http://localhost:9999/` - Аудиопоток из директории по умолчанию
   - `http://localhost:9999/humor` - Аудиопоток из директории с юмористическими треками
   - `http://localhost:9999/science` - Аудиопоток из директории с научными треками

### С использованием Docker

1. Клонируйте репозиторий и перейдите в директорию проекта:
```bash
git clone https://github.com/aposazhennikov/stream-audio-to-web.git
cd stream-audio-to-web
```

2. Соберите Docker образ с настройками по умолчанию:
```bash
# Использование маршрутов и директорий по умолчанию
docker build -t audio-streamer .

# Пользовательские настройки маршрутов и директорий
docker build -t audio-streamer \
  --build-arg AUDIO_STREAM_ROUTES="/,/humor,/science,/business" \
  --build-arg DIRECTORY_ROUTES='{"humor":"/app/humor","science":"/app/science","business":"/app/business"}' \
  --build-arg STREAM_MODE="radio" \
  --build-arg BUFFER_SIZE=1048576 \
  --build-arg MAX_PRELOAD_TRACKS=1 .
```

3. Запустите контейнер, примонтировав директории с аудиофайлами:
```bash
# Монтирование всех директорий одновременно
docker run -d --name audio-stream-server -p 9999:9999 \
  -v /путь/к/директории/с/юмором:/app/humor \
  -v /путь/к/директории/с/наукой:/app/science \
  -v /путь/к/директории/по/умолчанию:/app/audio \
  audio-streamer

# Запуск с переопределением настроек через переменные окружения
docker run -d --name audio-stream-server -p 9999:9999 \
  -v /путь/к/директории/с/юмором:/app/humor \
  -v /путь/к/директории/с/наукой:/app/science \
  -e DIRECTORY_ROUTES='{"humor":"/app/humor","science":"/app/science"}' \
  -e AUDIO_STREAM_ROUTES="/,/humor,/science" \
  -e STREAM_MODE="radio" \
  -e BUFFER_SIZE=1048576 \
  -e MAX_PRELOAD_TRACKS=1 \
  audio-streamer
```

4. Управление запущенным контейнером:
```bash
# Просмотр логов
docker logs audio-stream-server

# Остановка контейнера
docker stop audio-stream-server

# Перезапуск контейнера
docker restart audio-stream-server
```

5. Проверка доступных маршрутов аудиопотока:
```bash
# Список всех доступных маршрутов
curl http://localhost:9999/streams
```

6. Доступ к различным аудиопотокам:
   - `http://localhost:9999/` - Аудиопоток из директории по умолчанию (`/app/audio`)
   - `http://localhost:9999/humor` - Аудиопоток из директории с юмористическими треками (`/app/humor`)
   - `http://localhost:9999/science` - Аудиопоток из директории с научными треками (`/app/science`)

## Использование нескольких источников аудио

С новой функциональностью вы можете настроить разные URL-пути для доступа к потокам из разных директорий. Это позволяет организовать аудио по категориям или тематикам.

### Пример структуры:

```
/app/audio   → http://ваш_сервер:9999/       (общий контент)
/app/humor   → http://ваш_сервер:9999/humor  (юмористический контент)
/app/science → http://ваш_сервер:9999/science (научный контент)
```

### Преимущества:

- Разделение контента по категориям
- Независимое обновление разных категорий
- Возможность направить разные устройства на разные категории контента
- Упрощение организации аудиофайлов

## Описание модулей

### main.py
Основной исполняемый файл приложения. Обрабатывает аргументы командной строки, инициализирует логгер, менеджер плейлиста и запускает веб-сервер для трансляции аудио.

### logger.py
Настраивает систему логирования и интеграцию с Sentry для отслеживания ошибок.

### playlist_manager.py
Класс `PlaylistManager` сканирует указанные директории для поиска MP3 и WAV файлов, создает плейлисты и предоставляет методы для навигации по ним. Автоматически перемешивает файлы для разнообразного воспроизведения.

Включает классы:
- `DirectoryPlaylist` - управляет плейлистом из одной директории
- `AudioStreamBuffer` - буферизует аудиопоток для синхронизации слушателей
- `RadioStream` - создает единый непрерывный радиопоток для определенного маршрута

### audio_streamer.py
Класс `AudioStreamer` обрабатывает аудиофайлы и создает потоки данных для веб-трансляции. Использует библиотеку pydub для работы с аудио. Содержит специальную обработку для файлов с Unicode и специальными символами в именах.

### web_server.py
Класс `AudioStreamServer` создает веб-сервер на Flask, который обеспечивает потоковую передачу аудио в браузер. Включает HTML-шаблон для веб-интерфейса с аудиоплеером и отображением информации о текущем треке. Поддерживает настраиваемые URL-пути для аудиопотоков из разных директорий.

## API и эндпоинты

Сервер имеет следующие эндпоинты:

- `/streams` - возвращает JSON со списком всех доступных потоков, их маршрутами и текущими треками
- `/now-playing` - возвращает информацию о текущем проигрываемом треке
- `/reload-playlist` - перезагружает плейлист (можно указать конкретный маршрут)
- `/web` - веб-интерфейс с плеером для прослушивания
- `/<route>` - конечная точка для прямого прослушивания аудиопотока (где `<route>` - это зарегистрированный маршрут)

## Требования

- Python 3.6 или выше
- ffmpeg (для работы с аудиофайлами)
- Зависимости из файла requirements.txt
