# Аудио Стриминг Сервер

Это приложение создает веб-сервер для потоковой передачи аудиофайлов в браузер. Приложение может транслировать контент из разных директорий на разные URL-пути, что позволяет организовать тематические потоки.

## Возможности

- Автоматическое сканирование директорий для поиска .mp3 и .wav файлов
- Полная поддержка Unicode и специальных символов в именах файлов
- Трансляция аудиофайлов через HTTP
- Автоматическое воспроизведение аудиопотока в браузере
- Отображение информации о текущем треке
- Автоматический переход к следующему треку после завершения воспроизведения
- Логирование ошибок в Sentry
- Контейнеризация с использованием Docker
- Настраиваемые URL-пути для аудиопотоков (например, `/humor`, `/science` и т.д.)
- **Новое**: Поддержка трансляции разных директорий на разные URL-пути

## Архитектура проекта

Проект разделен на несколько модулей:

- `main.py` - Главный модуль приложения, инициализирует и запускает все компоненты
- `playlist_manager.py` - Сканирует директорию и управляет плейлистом аудиофайлов
- `audio_streamer.py` - Обрабатывает аудиофайлы и создает потоковый контент
- `web_server.py` - Веб-сервер для доставки аудиопотока через HTTP
- `logger.py` - Настраивает логирование и интеграцию с Sentry

## Режимы работы

Приложение поддерживает два режима работы:

1. **Режим совместимости**: Одна папка с аудио, несколько URL-путей для доступа
2. **Режим множественных потоков**: Несколько папок с аудио, каждая со своим URL-путем

## Запуск приложения

### Параметры командной строки

Приложение поддерживает следующие параметры командной строки:

- `--audio-dir` - Путь к директории с аудиофайлами (по умолчанию: /app/audio)
- `--port` - Порт для веб-сервера (по умолчанию: 9999)
- `--host` - Хост для веб-сервера (по умолчанию: 0.0.0.0)
- `--stream-routes` - Список URL-путей для аудиопотока в режиме совместимости
- `--folder-route-map` - Карта соответствия папок и маршрутов в формате "путь1:маршрут1,путь2:маршрут2"

### Переменные окружения

Приложение поддерживает следующие переменные окружения:

- `AUDIO_STREAM_ROUTES` - Список URL-путей для аудиопотока в режиме совместимости, разделенных запятыми (по умолчанию: `/`). Например: `/,/humor,/science`
- `FOLDER_ROUTE_MAP` - Карта соответствия папок и маршрутов в формате "путь1:маршрут1,путь2:маршрут2". Например: "/app/humor:/humor,/app/science:/science,/app/audio:/"
- `AUDIO_DIR` - Путь к директории с аудиофайлами в режиме совместимости (по умолчанию: /app/audio)

### Локально

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Установите ffmpeg (необходим для работы с аудиофайлами):
```bash
# Для Ubuntu/Debian
sudo apt-get install ffmpeg

# Для macOS с Homebrew
brew install ffmpeg

# Для Windows с Chocolatey
choco install ffmpeg
```

3. Запустите приложение в режиме совместимости:
```bash
python main.py --audio-dir /путь/к/директории/с/музыкой
```

4. Или запустите в режиме множественных потоков:
```bash
python main.py --folder-route-map "/путь/к/юмору:/humor,/путь/к/науке:/science"
```

5. Для настройки режима совместимости можно установить переменную окружения:
```bash
# Linux/macOS
export AUDIO_STREAM_ROUTES="/humor,/science,/"
python main.py --audio-dir /путь/к/директории/с/музыкой

# Windows PowerShell
$env:AUDIO_STREAM_ROUTES="/humor,/science,/"
python main.py --audio-dir C:\путь\к\директории\с\музыкой

# Windows CMD
set AUDIO_STREAM_ROUTES=/humor,/science,/
python main.py --audio-dir C:\путь\к\директории\с\музыкой
```

6. Для настройки режима множественных потоков через переменную окружения:
```bash
# Linux/macOS
export FOLDER_ROUTE_MAP="/путь/к/юмору:/humor,/путь/к/науке:/science,/путь/к/музыке:/"
python main.py

# Windows PowerShell
$env:FOLDER_ROUTE_MAP="/путь/к/юмору:/humor,/путь/к/науке:/science"
python main.py

# Windows CMD
set FOLDER_ROUTE_MAP=/путь/к/юмору:/humor,/путь/к/науке:/science
python main.py
```

7. Откройте в браузере соответствующие URL для прослушивания потоков:
   - `http://localhost:9999/humor` - для потока юмора
   - `http://localhost:9999/science` - для потока науки
   - `http://localhost:9999/` - для основного потока

### С использованием Docker

1. Клонируйте репозиторий и перейдите в директорию проекта:
```bash
git clone https://github.com/aposazhennikov/stream-audio-to-web.git
cd stream-audio-to-web
```

2. Соберите Docker образ с настройками по умолчанию:
```bash
docker build -t audio-streamer .
```

3. Или соберите Docker образ с пользовательскими настройками:
```bash
# Настройка режима совместимости
docker build -t audio-streamer --build-arg AUDIO_STREAM_ROUTES="/humor,/science,/" .

# Настройка режима множественных потоков
docker build -t audio-streamer --build-arg FOLDER_ROUTE_MAP="/app/humor:/humor,/app/science:/science,/app/business:/business" .
```

4. Запустите контейнер с монтированием одной директории (режим совместимости):
```bash
docker run -d --name audio-stream-server -p 9999:9999 -v /путь/к/директории/с/музыкой:/app/audio audio-streamer
```

5. Или запустите с монтированием нескольких директорий (режим множественных потоков):
```bash
docker run -d --name audio-stream-server -p 9999:9999 \
  -v /путь/к/юмору:/app/humor \
  -v /путь/к/науке:/app/science \
  -v /путь/к/бизнесу:/app/business \
  audio-streamer
```

6. Можно также переопределить настройки при запуске контейнера:
```bash
# Переопределение режима совместимости
docker run -d --name audio-stream-server -p 9999:9999 \
  -v /путь/к/директории/с/музыкой:/app/audio \
  -e AUDIO_STREAM_ROUTES="/rock,/pop,/" \
  audio-streamer

# Переопределение режима множественных потоков
docker run -d --name audio-stream-server -p 9999:9999 \
  -v /путь/к/юмору:/app/humor \
  -v /путь/к/науке:/app/science \
  -e FOLDER_ROUTE_MAP="/app/humor:/stand-up,/app/science:/education" \
  audio-streamer
```

7. Управление запущенным контейнером:
```bash
# Просмотр логов
docker logs audio-stream-server

# Остановка контейнера
docker stop audio-stream-server

# Перезапуск контейнера
docker restart audio-stream-server
```

8. Проверка доступных маршрутов аудиопотока:
```bash
# Список всех доступных маршрутов
curl http://localhost:9999/streams
```

## Использование веб-интерфейса

Приложение предоставляет веб-интерфейс для доступа к аудиопотокам:

- `http://ваш_сервер:9999/web` - основной веб-интерфейс со списком всех доступных потоков
- `http://ваш_сервер:9999/web/humor` - веб-интерфейс для потока юмора
- `http://ваш_сервер:9999/web/science` - веб-интерфейс для потока науки
- и т.д.

## Примеры использования

### Пример 1: Простой аудиосервер с одним потоком

```bash
docker run -d -p 9999:9999 -v /путь/к/музыке:/app/audio audio-streamer
```

### Пример 2: Аудиосервер с несколькими тематическими потоками

```bash
docker run -d -p 9999:9999 \
  -v /путь/к/юмору:/app/humor \
  -v /путь/к/науке:/app/science \
  -v /путь/к/бизнесу:/app/business \
  -v /путь/к/музыке:/app/audio \
  audio-streamer
```

### Пример 3: Кастомные пути для потоков

```bash
docker run -d -p 9999:9999 \
  -v /путь/к/радио1:/app/radio1 \
  -v /путь/к/радио2:/app/radio2 \
  -e FOLDER_ROUTE_MAP="/app/radio1:/moscow,/app/radio2:/spb" \
  audio-streamer
```

## Описание эндпоинтов API

- `/{route}` - Прямой аудиопоток (например, `/humor`, `/science`, `/`)
- `/web` - Основной веб-интерфейс со списком всех доступных потоков
- `/web/{route}` - Веб-интерфейс для конкретного потока (например, `/web/humor`)
- `/stream/{route}` - Эндпоинт для потокового аудио (используется веб-интерфейсом)
- `/now-playing/{route}` - Информация о текущем треке для конкретного потока
- `/streams` - Список всех доступных аудиопотоков
- `/reload-playlist/{route}` - Перезагрузка плейлиста для конкретного потока
- `/reload-playlist` - Перезагрузка всех плейлистов

## Описание модулей

### main.py
Основной исполняемый файл приложения. Обрабатывает аргументы командной строки, инициализирует логгер и запускает веб-сервер для трансляции аудио. Поддерживает два режима работы: совместимости и множественных потоков.

### logger.py
Настраивает систему логирования и интеграцию с Sentry для отслеживания ошибок.

### playlist_manager.py
Класс `PlaylistManager` сканирует указанную директорию для поиска MP3 и WAV файлов, создает плейлист и предоставляет методы для навигации по нему. Автоматически перемешивает файлы для разнообразного воспроизведения.

### audio_streamer.py
Класс `AudioStreamer` обрабатывает аудиофайлы и создает потоки данных для веб-трансляции. Использует библиотеку pydub для работы с аудио. Содержит специальную обработку для файлов с Unicode и специальными символами в именах.

### web_server.py
Класс `AudioStreamServer` создает веб-сервер на Flask, который обеспечивает потоковую передачу аудио в браузер. Включает HTML-шаблон для веб-интерфейса с аудиоплеером и отображением информации о текущем треке. Поддерживает настраиваемые URL-пути для аудиопотоков и маппинг разных директорий на разные URL-пути.

## Требования

- Python 3.6 или выше
- ffmpeg (для работы с аудиофайлами)
- Зависимости из файла requirements.txt
