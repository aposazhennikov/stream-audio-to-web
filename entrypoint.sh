#!/bin/sh
set -e

# Список директорий для проверки (убран /app/audio)
AUDIO_DIRS=""

# Добавление дополнительных директорий из переменной окружения DIRECTORY_ROUTES
if [ -n "$DIRECTORY_ROUTES" ]; then
    # Извлечение путей директорий из JSON строки
    DIRS_FROM_ENV=$(echo "$DIRECTORY_ROUTES" | grep -o '"/app/[^"]*"' | tr -d '"')
    for dir in $DIRS_FROM_ENV; do
        if [ -d "$dir" ]; then
            AUDIO_DIRS="$AUDIO_DIRS $dir"
        fi
    done
fi

# Если переменная пустая, выставляем значения по умолчанию для юмора и науки
if [ -z "$AUDIO_DIRS" ]; then
    AUDIO_DIRS="/app/humor /app/science"
fi

echo "Проверка директорий с аудио: $AUDIO_DIRS"

# Проверка и исправление прав доступа для директорий и файлов
for dir in $AUDIO_DIRS; do
    if [ -d "$dir" ]; then
        echo "Проверка директории: $dir"
        
        # Если директория не читаема для текущего пользователя
        if [ ! -r "$dir" ]; then
            echo "Недостаточно прав для чтения директории: $dir"
            
            # Попытка применить права только если запущено от root
            if [ "$(id -u)" = "0" ]; then
                echo "Устанавливаем права на чтение для директории: $dir"
                chmod -R +r "$dir" || echo "Не удалось установить права на чтение для $dir"
            else
                echo "ПРЕДУПРЕЖДЕНИЕ: Недостаточно прав для изменения прав доступа. Директория $dir может быть недоступна."
            fi
        fi
        
        # Проверка прав на чтение для всех файлов в директории
        find "$dir" -type f \( -name "*.mp3" -o -name "*.aac" -o -name "*.ogg" \) | while read -r file; do
            if [ ! -r "$file" ]; then
                echo "Недостаточно прав для чтения файла: $file"
                
                # Попытка применить права только если запущено от root
                if [ "$(id -u)" = "0" ]; then
                    echo "Устанавливаем права на чтение для файла: $file"
                    chmod +r "$file" || echo "Не удалось установить права на чтение для $file"
                else
                    echo "ПРЕДУПРЕЖДЕНИЕ: Недостаточно прав для изменения прав доступа. Файл $file может быть недоступен."
                fi
            fi
        done
    else
        echo "Директория $dir не существует, создаем..."
        mkdir -p "$dir"
        chmod -R 755 "$dir"
    fi
done

# Проверка сетевых привилегий
if [ "$(id -u)" = "0" ]; then
    echo "Настройка сетевого стека для надежной работы HTTP сервера..."
    # Разрешаем повторное использование портов
    sysctl -w net.ipv4.tcp_tw_reuse=1 2>/dev/null || echo "Пропуск настройки sysctl (не поддерживается)"
fi

# Увеличиваем лимит файловых дескрипторов, если это возможно
ulimit -n 4096 2>/dev/null || echo "Пропуск увеличения лимита дескрипторов (не поддерживается)"

echo "Подготовка завершена, запуск приложения..."

# Запуск основного приложения
exec "$@" 